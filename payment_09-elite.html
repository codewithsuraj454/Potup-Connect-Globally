<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secure Checkout | Potup Badges</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
body { 
  font-family: 'Inter', sans-serif; 
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  color: #f8fafc; 
}

.glass-card { 
  background: rgba(30, 41, 59, 0.95);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(51, 65, 85, 0.5);
  border-radius: 24px;
  box-shadow: 
    0 25px 50px -12px rgba(0, 0, 0, 0.7),
    0 0 0 1px rgba(255, 255, 255, 0.05) inset;
}

.gradient-header {
  background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
  position: relative;
  overflow: hidden;
}

.gradient-header::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  animation: pulse 4s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: translate(0, 0); }
  50% { transform: translate(-5%, 5%); }
}

.success-check { 
  animation: scaleIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
}

@keyframes scaleIn { 
  from { transform: scale(0) rotate(-180deg); opacity: 0; } 
  to { transform: scale(1) rotate(0); opacity: 1; } 
}

input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button { 
  -webkit-appearance: none; 
  margin: 0; 
}

input[type=number] {
  -moz-appearance: textfield;
}

.btn-primary {
  background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.btn-primary:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.5);
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn-primary::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255,255,255,0.2);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.btn-primary:active:not(:disabled)::before {
  width: 300px;
  height: 300px;
}

.btn-secondary {
  background: rgba(51, 65, 85, 0.8);
  border: 1px solid rgba(100, 116, 139, 0.5);
  transition: all 0.3s ease;
}

.btn-secondary:hover {
  background: rgba(51, 65, 85, 1);
  border-color: rgba(100, 116, 139, 0.8);
  transform: translateY(-1px);
}

.secure-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: rgba(16, 185, 129, 0.1);
  border: 1px solid rgba(16, 185, 129, 0.3);
  padding: 6px 12px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 600;
  color: #10b981;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.qr-container {
  background: white;
  padding: 20px;
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  position: relative;
}

.qr-container::after {
  content: '';
  position: absolute;
  inset: -2px;
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  border-radius: 22px;
  z-index: -1;
  opacity: 0.5;
}

.input-field {
  background: rgba(15, 23, 42, 0.8);
  border: 2px solid rgba(100, 116, 139, 0.3);
  transition: all 0.3s ease;
}

.input-field:focus {
  outline: none;
  border-color: #6366f1;
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  background: rgba(15, 23, 42, 0.95);
}

.fade-in {
  animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.loading-spinner {
  border: 3px solid rgba(255, 255, 255, 0.1);
  border-top: 3px solid #6366f1;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-overlay {
  background: rgba(15, 23, 42, 0.98);
  backdrop-filter: blur(10px);
}
</style>
</head>

<body class="flex items-center justify-center min-h-screen p-4">

<!-- Loading Screen -->
<div id="loading-screen" class="fixed inset-0 loading-overlay flex items-center justify-center z-50">
    <div class="text-center">
        <div class="loading-spinner mx-auto mb-4" style="width: 48px; height: 48px; border-width: 4px;"></div>
        <p class="text-slate-300 text-lg">Checking authentication...</p>
    </div>
</div>

<!-- Login Required Screen -->
<div id="login-required" class="hidden w-full max-w-md glass-card p-8 text-center fade-in">
    <div class="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
        <svg class="w-10 h-10 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
        </svg>
    </div>
    <h1 class="text-2xl font-bold mb-3">Login Required</h1>
    <p class="text-slate-400 mb-6">You need to be logged in to purchase Elite Badge</p>
    <button onclick="window.location.href='index.html'" class="btn-primary w-full py-4 rounded-2xl font-semibold">
        Go to Login
    </button>
</div>

<!-- Main Checkout -->
<div id="checkout-content" class="hidden w-full max-w-md glass-card overflow-hidden fade-in">
    <!-- Header -->
    <div class="gradient-header p-8 text-center relative z-10">
        <div class="secure-badge mb-3">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
            Secure Checkout
        </div>
        <h1 class="text-3xl font-bold mt-2 mb-1">Potup Elite Badge</h1>
        <p class="text-indigo-200 text-sm opacity-90">Unlock premium features</p>
        <div class="mt-6">
            <div class="text-5xl font-extrabold tracking-tight">‚Çπ200<span class="text-2xl font-normal">.00</span></div>
        </div>
    </div>

    <!-- Content -->
    <div class="p-8">
        <!-- Payment Step -->
        <div id="payment-step">
            <!-- Desktop QR View -->
            <div id="desktop-view" class="hidden">
                <div class="text-center mb-6">
                    <h2 class="text-lg font-semibold mb-2">Scan QR Code</h2>
                    <p class="text-slate-400 text-sm">Use any UPI app to complete payment</p>
                </div>
                
                <div class="flex justify-center mb-6">
                    <div class="qr-container">
                        <div id="qrcode"></div>
                    </div>
                </div>

                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50 mb-6">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-indigo-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div class="text-sm text-slate-300">
                            <p class="font-medium mb-1">Payment Instructions:</p>
                            <ol class="list-decimal list-inside space-y-1 text-slate-400">
                                <li>Open any UPI app (GPay, PhonePe, Paytm)</li>
                                <li>Scan the QR code above</li>
                                <li>Complete the payment</li>
                                <li>Save your 12-digit UTR number</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mobile UPI View -->
            <div id="mobile-view" class="hidden">
                <div class="text-center mb-6">
                    <h2 class="text-lg font-semibold mb-2">Pay with UPI</h2>
                    <p class="text-slate-400 text-sm">Complete payment in your UPI app</p>
                </div>

                <button onclick="payViaIntent()" class="btn-secondary w-full p-5 rounded-2xl font-semibold text-base mb-6 flex items-center justify-center gap-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Open UPI App
                </button>

                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-indigo-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-sm text-slate-300">After payment, return here and enter your 12-digit UTR number to verify.</p>
                    </div>
                </div>
            </div>

            <!-- Complete Payment Button -->
            <button onclick="showVerify()" class="btn-primary w-full mt-6 py-4 rounded-2xl font-semibold text-base shadow-lg">
                I've Completed Payment
            </button>
        </div>

        <!-- Verify Step -->
        <div id="verify-step" class="hidden fade-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-indigo-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h2 class="text-xl font-bold mb-2">Verify Your Payment</h2>
                <p class="text-slate-400 text-sm">Enter the 12-digit UTR/Transaction ID</p>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-slate-300 mb-2">Transaction ID (UTR)</label>
                <input 
                    type="number" 
                    id="utr-input" 
                    placeholder="123456789012"
                    maxlength="12"
                    class="input-field w-full p-4 rounded-xl text-center text-xl font-mono tracking-wider"
                >
                <p id="error-msg" class="text-red-400 text-xs text-center mt-2 hidden flex items-center justify-center gap-1">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    Please enter a valid 12-digit UTR number
                </p>
            </div>

            <div class="bg-amber-500/10 border border-amber-500/30 rounded-xl p-4 mb-6">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <p class="text-sm text-amber-200">You can find the UTR number in your UPI app's payment history or SMS confirmation.</p>
                </div>
            </div>

            <button onclick="handleSuccess()" id="submit-btn" class="btn-primary w-full py-4 rounded-2xl font-semibold text-base shadow-lg flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Submit & Verify Payment
            </button>

            <button onclick="goBack()" class="w-full mt-3 py-3 text-slate-400 hover:text-slate-200 font-medium text-sm transition-colors">
                ‚Üê Back to Payment
            </button>
        </div>
    </div>
</div>

<!-- Success Overlay -->
<div id="success-overlay" class="fixed inset-0 bg-black/95 backdrop-blur-sm hidden flex items-center justify-center z-50">
    <div class="text-center px-6">
        <div class="w-24 h-24 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-full flex items-center justify-center mb-6 mx-auto success-check shadow-2xl">
            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
            </svg>
        </div>
        <h1 class="text-3xl font-bold mb-2">Payment Successful!</h1>
        <p class="text-slate-400 mb-4">Elite Badge has been added to your account</p>
        <div class="flex items-center justify-center gap-2 text-indigo-400">
            <div class="loading-spinner"></div>
            <span class="text-sm">Redirecting to dashboard...</span>
        </div>
    </div>
</div>

<script>
/* ================= CONFIG ================= */
const UPI_ID = "9777441431@mbk";
const NAME = "Potup";
const AMOUNT = "200.00";

const upiString = `upi://pay?pa=${UPI_ID}&pn=${encodeURIComponent(NAME)}&am=${AMOUNT}&cu=INR`;

/* ================= SUPABASE CLIENT (EXACT SAME AS HOME PAGE) ================= */
const SUPABASE_URL = "https://hdauaegfmenlzhqnfgvy.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkYXVhZWdmbWVubHpocW5mZ3Z5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDc0MzAsImV4cCI6MjA4MTAyMzQzMH0.8IHXBnKm6pE5cwBGPo7m0eIWdtVPsQDL1CUozebpNDE";

// Initialize with SAME config as home page
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: true,
    storage: window.localStorage,
    storageKey: 'potup-auth-token', // CRITICAL: Same as home page
    flowType: 'pkce'
  }
});

// Global state
let currentUser = null;
let currentUserProfile = null;

/* ================= CHECK AUTHENTICATION (EXACT SAME PATTERN AS HOME PAGE) ================= */
async function checkAndInitializeSession() {
  try {
    console.log('üîç Checking for existing session...');
    
    const { data: { session }, error } = await sb.auth.getSession();
    
    if (error) {
      console.error('‚ùå Session check error:', error);
      showLoginRequired();
      return false;
    }
    
    if (session?.user) {
      console.log('‚úÖ Found existing session for:', session.user.email);
      currentUser = session.user;
      
      // Load user profile
      const profileLoaded = await loadUserProfile();
      
      if (!profileLoaded) {
        console.error('‚ùå Failed to load profile');
        showLoginRequired();
        return false;
      }
      
      // Check Elite ownership
      const ownsElite = await checkEliteOwnership(currentUser.id);
      
      if (ownsElite) {
        console.log('‚úÖ User already owns Elite badge, redirecting...');
        window.location.replace("home.html");
        return false;
      }
      
      console.log('‚úÖ User authenticated, showing checkout');
      showCheckout();
      initializePaymentUI();
      return true;
    } else {
      console.log('‚ÑπÔ∏è No existing session found');
      showLoginRequired();
      return false;
    }
  } catch (error) {
    console.error('‚ùå Session check failed:', error);
    showLoginRequired();
    return false;
  }
}

/* ================= LOAD USER PROFILE ================= */
async function loadUserProfile() {
  if (!currentUser) {
    console.error('No current user');
    return false;
  }

  console.log('üìã Loading profile for:', currentUser.id);

  try {
    const { data, error } = await sb
      .from('user_profiles')
      .select('*')
      .eq('id', currentUser.id)
      .maybeSingle();

    if (error && error.code !== 'PGRST116') {
      console.error('Profile fetch error:', error);
      throw error;
    }

    if (data) {
      currentUserProfile = data;
      console.log('‚úÖ Profile found:', data.user_id);
      return true;
    }

    console.log('‚ùå Profile not found');
    return false;

  } catch (error) {
    console.error('loadUserProfile failed:', error);
    return false;
  }
}

/* ================= CHECK ELITE OWNERSHIP ================= */
async function checkEliteOwnership(userId) {
  try {
    console.log('üîç Checking Elite badge for user:', userId);
    
    const { data, error } = await sb
      .from("user_profiles")
      .select("badges")
      .eq("id", userId)
      .single();

    if (error) {
      console.error('‚ùå Error fetching badges:', error);
      throw error;
    }

    console.log('üìã User badges:', data?.badges);

    const badges = data?.badges ?? "";
    const ownsElite = /(^|,\s*)elite(\s*,|$)/i.test(badges);

    console.log('üéñÔ∏è Owns Elite?', ownsElite);
    return ownsElite;

  } catch (err) {
    console.error('‚ùå Elite check failed:', err.message);
    return false;
  }
}

/* ================= UI STATE MANAGEMENT ================= */
function showLoginRequired() {
  document.getElementById("loading-screen").classList.add("hidden");
  document.getElementById("login-required").classList.remove("hidden");
  document.getElementById("checkout-content").classList.add("hidden");
}

function showCheckout() {
  document.getElementById("loading-screen").classList.add("hidden");
  document.getElementById("login-required").classList.add("hidden");
  document.getElementById("checkout-content").classList.remove("hidden");
}

/* ================= INITIALIZE PAYMENT UI ================= */
function initializePaymentUI() {
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

  if (isMobile) {
    console.log('üì± Mobile device detected');
    document.getElementById("mobile-view").classList.remove("hidden");
  } else {
    console.log('üíª Desktop device detected');
    document.getElementById("desktop-view").classList.remove("hidden");
    new QRCode(document.getElementById("qrcode"), {
      text: upiString,
      width: 200,
      height: 200,
      colorDark: "#1e293b",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H
    });
  }

  console.log('‚úÖ Checkout page ready');
}

/* ================= INITIALIZATION ================= */
document.addEventListener('DOMContentLoaded', async () => {
  console.log('üöÄ Checkout page initializing...');
  await checkAndInitializeSession();
});

/* ================= PAYMENT FLOW ================= */
function payViaIntent() {
  console.log('üì≤ Opening UPI app...');
  window.location.href = upiString;
}

function showVerify() {
  console.log('‚úèÔ∏è Showing verification form');
  document.getElementById("payment-step").classList.add("hidden");
  document.getElementById("verify-step").classList.remove("hidden");
}

function goBack() {
  console.log('‚¨ÖÔ∏è Going back to payment');
  document.getElementById("verify-step").classList.add("hidden");
  document.getElementById("payment-step").classList.remove("hidden");
  document.getElementById("utr-input").value = "";
  document.getElementById("error-msg").classList.add("hidden");
}

/* ================= BADGE UPDATE ================= */
async function handleSuccess() {
  const utr = document.getElementById("utr-input").value.trim();
  const error = document.getElementById("error-msg");
  const submitBtn = document.getElementById("submit-btn");

  console.log('üí≥ Processing payment verification...');

  // Validate UTR
  if (utr.length !== 12) {
    console.log('‚ùå Invalid UTR length:', utr.length);
    error.classList.remove("hidden");
    return;
  }
  error.classList.add("hidden");

  // Use authenticated user ID
  if (!currentUser || !currentUser.id) {
    console.error('‚ùå No authenticated user found');
    alert('Session expired. Please login again.');
    window.location.href = "index.html";
    return;
  }

  console.log('üîÑ Verifying for user:', currentUser.id);

  // Disable button and show loading
  submitBtn.disabled = true;
  submitBtn.innerHTML = `
    <div class="loading-spinner"></div>
    <span>Verifying...</span>
  `;

  try {
    console.log('üì° Calling add_elite_badge_text RPC...');
    
    // Add Elite badge using Supabase RPC
    const { data, error: rpcError } = await sb.rpc("add_elite_badge_text", {
      uid: currentUser.id
    });

    if (rpcError) {
      console.error('‚ùå RPC error:', rpcError);
      throw rpcError;
    }

    console.log('‚úÖ Badge added successfully!');
    console.log('üéâ Payment verified, showing success...');

    // Show success overlay
    document.getElementById("success-overlay").classList.remove("hidden");
    
    // Redirect after 3 seconds
    setTimeout(() => {
      console.log('‚Ü™Ô∏è Redirecting to home...');
      window.location.replace("home.html");
    }, 3000);

  } catch (err) {
    console.error('‚ùå Verification failed:', err);
    
    // Reset button on error
    submitBtn.disabled = false;
    submitBtn.innerHTML = `
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      Submit & Verify Payment
    `;
    
    alert("Verification failed: " + err.message);
  }
}

/* ================= UTR INPUT VALIDATION ================= */
document.addEventListener('DOMContentLoaded', function() {
  const utrInput = document.getElementById('utr-input');
  if (utrInput) {
    utrInput.addEventListener('input', function(e) {
      // Limit to 12 digits
      if (this.value.length > 12) {
        this.value = this.value.slice(0, 12);
      }
    });
  }
});

/* ================= AUTH STATE LISTENER (SAME AS HOME PAGE) ================= */
sb.auth.onAuthStateChange((event, session) => {
  console.log('üîî Auth state changed:', event);
  
  if (event === 'SIGNED_OUT') {
    console.log('üëã User signed out, redirecting to login');
    window.location.href = "